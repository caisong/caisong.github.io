<!doctype html><html lang=en-us x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Windows移植linux | Caisong's Blog</title>
<link rel=canonical href=https://caisong.github.io/posts/windows%E7%A7%BB%E6%A4%8Dlinux/><meta name=author content="Cai Song"><meta name=description content="Cut out summary from your post content here.
"><meta name=keywords content="Linux,Windows"><meta name=generator content="Hugo 0.140.2"><meta property="og:url" content="https://caisong.github.io/posts/windows%E7%A7%BB%E6%A4%8Dlinux/"><meta property="og:site_name" content="Caisong's Blog"><meta property="og:title" content="Windows移植linux"><meta property="og:description" content="Cut out summary from your post content here."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-10-29T20:13:54+08:00"><meta property="article:modified_time" content="2017-10-29T20:13:54+08:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Windows"><meta property="og:image" content="https://caisong.github.io/img/background.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://caisong.github.io/img/background.jpg"><meta name=twitter:title content="Windows移植linux"><meta name=twitter:description content="Cut out summary from your post content here."><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:online" @click="flip = !flip" title="Flip it!"><div class="h-10 rounded-full"><img src=/img/avatar.png alt="A blog about all things technical."></div></div><div><a href=https://caisong.github.io/ class="text-lg font-semibold cursor-pointer">A blog about all things technical.</a></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=About><ion-icon name=information-circle></ion-icon>About</div></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title="All Categories"><ion-icon name=grid></ion-icon>All Categories</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=About>About</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title="All Categories"><ion-icon name=grid></ion-icon>All Categories</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="Windows移植linux"><meta itemprop=description content="Cut out summary from your post content here."><meta itemprop=datePublished content="2017-10-29T20:13:54+08:00"><meta itemprop=dateModified content="2017-10-29T20:13:54+08:00"><meta itemprop=wordCount content="3638"><meta itemprop=image content="https://caisong.github.io/img/background.jpg"><meta itemprop=keywords content="Linux,Windows"><header><h1 itemprop=headline>Windows移植linux</h1><p class=text-sm>Sunday, Oct 29, 2017
| <span>18 minute read</span>
| <span>Updated at
Sunday, Oct 29, 2017</span></p><div class="flex justify-between"><div class="flex items-center"><span>@</span>
<span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>Cai Song</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=Windows%e7%a7%bb%e6%a4%8dlinux&amp;url=https://caisong.github.io/posts/windows%E7%A7%BB%E6%A4%8Dlinux/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://caisong.github.io/posts/windows%E7%A7%BB%E6%A4%8Dlinux/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://wa.me/?text=Windows%e7%a7%bb%e6%a4%8dlinux%20https://caisong.github.io/posts/windows%E7%A7%BB%E6%A4%8Dlinux/" target=_blank rel="noopener noreferrer" title="Share on WhatsApp"><ion-icon class=group-hover:text-primary-content name=logo-whatsapp></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img src=/img/cover.jpg alt=Windows移植linux><p>Cut out summary from your post content here.</p><h2 id=数据层>数据层</h2><h3 id=数据库驱动>数据库驱动</h3><p>详细内容见《PostgreSQL调查》
数据库连接方式可以使用UnixODBC（ODBC驱动）或libpq（原生驱动）两种方式</p><table><thead><tr><th style=text-align:left>类型</th><th style=text-align:center>unixODBC</th><th style=text-align:center>libpq</th></tr></thead><tbody><tr><td style=text-align:left>优点</td><td style=text-align:center>代码改动小</td><td style=text-align:center>查询效率高</td></tr><tr><td style=text-align:left>缺点</td><td style=text-align:center>效率较低</td><td style=text-align:center>代码改动大</td></tr></tbody></table><h3 id=连接池>连接池</h3><ul><li>官方推荐的pgpoll-Ⅱ、pgbouncer第三方连接池。易于扩展、方便部署。</li><li>使用长连接建立简单的连接池。</li></ul><h2 id=网络层>网络层</h2><p>网络Epoll模型
客户端代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Filename:  client.c
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *    Description:  client example
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Version:  1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Created:  11/10/2016 11:03:37 PM
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Revision:  none
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Compiler:  gcc
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Author:  CaiSong (), cais.fnst@cn.fujitsu.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Company:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;netinet/in.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * ===  FUNCTION  ======================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Name:  main
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  Description:
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAXLINE 4096
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> sockaddr_in servaddr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>servIP <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;192.168.220.128&#34;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> sockfd;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> sendLine[MAXLINE] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> recvLine[MAXLINE] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> rec_len <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ((sockfd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;create socket error:%s (errno: %d )</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno), errno);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>servaddr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(servaddr));
</span></span><span style=display:flex><span>	servaddr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>	servaddr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(<span style=color:#ae81ff>43388</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>inet_pton</span>(AF_INET, servIP, <span style=color:#f92672>&amp;</span>servaddr.sin_addr) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;inet_pton error for %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, servIP);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>connect</span>(sockfd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>servaddr, <span style=color:#66d9ef>sizeof</span>(servaddr)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;connect error :%s (errno: %d)&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno), errno);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;send message to server</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fgets</span>(sendLine, <span style=color:#ae81ff>4096</span>, stdin);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>send</span>(sockfd, sendLine, <span style=color:#a6e22e>strlen</span>(sendLine), <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;send msg error:%s, (errno :%d)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno), errno);
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> ((rec_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recv</span>(sockfd, recvLine, MAXLINE, <span style=color:#ae81ff>0</span>)) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;recv error&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		recvLine[rec_len] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;server :%s </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, recvLine);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close</span>(sockfd);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;client offline</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>} <span style=color:#75715e>/* ----------  end of function main  ---------- */</span>
</span></span></code></pre></div><p>服务器端代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Filename:  epollEx.c
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *    Description:  epoll example
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Version:  1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Created:  11/10/2016 10:15:10 PM
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Revision:  none
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Compiler:  gcc
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Author:  CaiSong (), cais.fnst@cn.fujitsu.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Company:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;netdb.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/epoll.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAXEVENTS 64
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> data_send
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> fd;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>buff;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> len;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> flag;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>make_socket_non_blocking</span>(<span style=color:#66d9ef>int</span> sfd)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> flags, s;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	flags <span style=color:#f92672>=</span> <span style=color:#a6e22e>fcntl</span>(sfd, F_GETFL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (flags <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;fcntl&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	flags <span style=color:#f92672>|=</span> O_NONBLOCK;
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> <span style=color:#a6e22e>fcntl</span>(sfd, F_SETFL, flags);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;fcntl&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>create_and_bind</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>port)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> addrinfo hints;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> addrinfo <span style=color:#f92672>*</span>result, <span style=color:#f92672>*</span>rp;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> s, sfd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>hints, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> addrinfo));
</span></span><span style=display:flex><span>	hints.ai_family <span style=color:#f92672>=</span> AF_UNSPEC;     <span style=color:#75715e>/* Return IPv4 and IPv6 choices */</span>
</span></span><span style=display:flex><span>	hints.ai_socktype <span style=color:#f92672>=</span> SOCK_STREAM; <span style=color:#75715e>/* We want a TCP socket */</span>
</span></span><span style=display:flex><span>	hints.ai_flags <span style=color:#f92672>=</span> AI_PASSIVE;     <span style=color:#75715e>/* All interfaces */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> <span style=color:#a6e22e>getaddrinfo</span>(NULL, port, <span style=color:#f92672>&amp;</span>hints, <span style=color:#f92672>&amp;</span>result);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;getaddrinfo: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>gai_strerror</span>(s));
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (rp <span style=color:#f92672>=</span> result; rp <span style=color:#f92672>!=</span> NULL; rp <span style=color:#f92672>=</span> rp<span style=color:#f92672>-&gt;</span>ai_next)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		sfd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(rp<span style=color:#f92672>-&gt;</span>ai_family, rp<span style=color:#f92672>-&gt;</span>ai_socktype, rp<span style=color:#f92672>-&gt;</span>ai_protocol);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (sfd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		s <span style=color:#f92672>=</span> <span style=color:#a6e22e>bind</span>(sfd, rp<span style=color:#f92672>-&gt;</span>ai_addr, rp<span style=color:#f92672>-&gt;</span>ai_addrlen);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#75715e>/* We managed to bind successfully! */</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>close</span>(sfd);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (rp <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;Could not bind</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>freeaddrinfo</span>(result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> sfd;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> sfd, s;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> efd;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> data_send <span style=color:#f92672>*</span>data;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> epoll_event event;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> epoll_event <span style=color:#f92672>*</span>events;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//if (argc != 2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//{
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//    fprintf(stderr, &#34;Usage: %s [port]\n&#34;, argv[0]);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//    exit(EXIT_FAILURE);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	sfd <span style=color:#f92672>=</span> <span style=color:#a6e22e>create_and_bind</span>(<span style=color:#e6db74>&#34;43388&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (sfd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> <span style=color:#a6e22e>make_socket_non_blocking</span>(sfd);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> <span style=color:#a6e22e>listen</span>(sfd, SOMAXCONN);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;listen&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	efd <span style=color:#f92672>=</span> <span style=color:#a6e22e>epoll_create1</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (efd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;epoll_create&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	event.data.fd <span style=color:#f92672>=</span> sfd;
</span></span><span style=display:flex><span>	event.events <span style=color:#f92672>=</span> EPOLLIN <span style=color:#f92672>|</span> EPOLLET;
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> <span style=color:#a6e22e>epoll_ctl</span>(efd, EPOLL_CTL_ADD, sfd, <span style=color:#f92672>&amp;</span>event);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;epoll_ctl&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* Buffer where events are returned */</span>
</span></span><span style=display:flex><span>	events <span style=color:#f92672>=</span> <span style=color:#a6e22e>calloc</span>(MAXEVENTS, <span style=color:#66d9ef>sizeof</span> event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* The event loop */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> n, i;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		n <span style=color:#f92672>=</span> <span style=color:#a6e22e>epoll_wait</span>(efd, events, MAXEVENTS, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> n; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> ((events[i].events <span style=color:#f92672>&amp;</span> EPOLLERR) <span style=color:#f92672>||</span> (events[i].events <span style=color:#f92672>&amp;</span> EPOLLHUP) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>				(<span style=color:#f92672>!</span>(events[i].events <span style=color:#f92672>&amp;</span> EPOLLIN <span style=color:#f92672>||</span> events[i].events <span style=color:#f92672>&amp;</span> EPOLLOUT)))
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#75715e>/* An error has occured on this fd, or the socket is not
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   ready for reading (why were we notified then?) */</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;epoll error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>close</span>(events[i].data.fd);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sfd <span style=color:#f92672>==</span> events[i].data.fd)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#75715e>/* We have a notification on the listening socket, which
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   means one or more incoming connections. */</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>struct</span> sockaddr in_addr;
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>socklen_t</span> in_len;
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>int</span> infd;
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>char</span> hbuf[NI_MAXHOST], sbuf[NI_MAXSERV];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					in_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span> in_addr;
</span></span><span style=display:flex><span>					infd <span style=color:#f92672>=</span> <span style=color:#a6e22e>accept</span>(sfd, <span style=color:#f92672>&amp;</span>in_addr, <span style=color:#f92672>&amp;</span>in_len);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (infd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>if</span> ((errno <span style=color:#f92672>==</span> EAGAIN) <span style=color:#f92672>||</span> (errno <span style=color:#f92672>==</span> EWOULDBLOCK))
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							<span style=color:#75715e>/* We have processed all incoming
</span></span></span><span style=display:flex><span><span style=color:#75715e>							   connections. */</span>
</span></span><span style=display:flex><span>							<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;accept&#34;</span>);
</span></span><span style=display:flex><span>							<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					s <span style=color:#f92672>=</span> <span style=color:#a6e22e>getnameinfo</span>(<span style=color:#f92672>&amp;</span>in_addr, in_len, hbuf, <span style=color:#66d9ef>sizeof</span> hbuf, sbuf, <span style=color:#66d9ef>sizeof</span> sbuf,
</span></span><span style=display:flex><span>									NI_NUMERICHOST <span style=color:#f92672>|</span> NI_NUMERICSERV);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>printf</span>(
</span></span><span style=display:flex><span>							<span style=color:#e6db74>&#34;Accepted connection on descriptor %d &#34;</span>
</span></span><span style=display:flex><span>							<span style=color:#e6db74>&#34;(host=%s, port=%s)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>							infd, hbuf, sbuf);
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>/* Make the incoming socket non-blocking and add it to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>					   list of fds to monitor. */</span>
</span></span><span style=display:flex><span>					s <span style=color:#f92672>=</span> <span style=color:#a6e22e>make_socket_non_blocking</span>(infd);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					event.data.fd <span style=color:#f92672>=</span> infd;
</span></span><span style=display:flex><span>					event.events <span style=color:#f92672>=</span> EPOLLIN <span style=color:#f92672>|</span> EPOLLET;
</span></span><span style=display:flex><span>					s <span style=color:#f92672>=</span> <span style=color:#a6e22e>epoll_ctl</span>(efd, EPOLL_CTL_ADD, infd, <span style=color:#f92672>&amp;</span>event);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;epoll_ctl&#34;</span>);
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (events[i].events <span style=color:#f92672>&amp;</span> EPOLLIN)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#75715e>/* We have data on the fd waiting to be read. Read and
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   display it. We must read whatever data is available
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   completely, as we are running in edge-triggered mode
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   and won&#39;t get a notification again for the samen
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   data. */</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>ssize_t</span> count;
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>512</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>					fd <span style=color:#f92672>=</span> events[i].data.fd;
</span></span><span style=display:flex><span>					count <span style=color:#f92672>=</span> <span style=color:#a6e22e>read</span>(fd, buf, <span style=color:#66d9ef>sizeof</span> buf);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (count <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#75715e>/* If errno == EAGAIN, that means we have read all
</span></span></span><span style=display:flex><span><span style=color:#75715e>						   data. So go back to the main loop. */</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>if</span> (errno <span style=color:#f92672>!=</span> EAGAIN)
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;read&#34;</span>);
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (count <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#75715e>/* End of file. The remote has closed the
</span></span></span><span style=display:flex><span><span style=color:#75715e>						   connection. */</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>/* Write the buffer to standard output */</span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>// strcpy(recv, &#34;client: &#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// strcat(recv, buf);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// s = write(1, recv, strlen(recv));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// if (s == -1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>//{
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>//    perror(&#34;write&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>//    abort();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>//}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// strcpy(buf, &#34;hello, client&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// write(events[i].data.fd, buf, strlen(buf));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>write</span>(STDOUT_FILENO, buf, <span style=color:#a6e22e>strlen</span>(buf));
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				data <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> data_send <span style=color:#f92672>*</span>)<span style=color:#a6e22e>malloc</span>(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> data_send));
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>memset</span>(data, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> data_send));
</span></span><span style=display:flex><span>				data<span style=color:#f92672>-&gt;</span>fd <span style=color:#f92672>=</span> fd;
</span></span><span style=display:flex><span>				event.data.ptr <span style=color:#f92672>=</span> data;
</span></span><span style=display:flex><span>				event.events <span style=color:#f92672>=</span> EPOLLOUT <span style=color:#f92672>|</span> EPOLLET;
</span></span><span style=display:flex><span>				s <span style=color:#f92672>=</span> <span style=color:#a6e22e>epoll_ctl</span>(efd, EPOLL_CTL_MOD, fd, <span style=color:#f92672>&amp;</span>event);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;epoll_ctl&#34;</span>);
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				data<span style=color:#f92672>-&gt;</span>buff <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(<span style=color:#ae81ff>64</span>);
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>strcpy</span>(data<span style=color:#f92672>-&gt;</span>buff, <span style=color:#e6db74>&#34;hello&#34;</span>);
</span></span><span style=display:flex><span>				data<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(data<span style=color:#f92672>-&gt;</span>buff);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (events[i].events <span style=color:#f92672>&amp;</span> EPOLLOUT)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>struct</span> data_send <span style=color:#f92672>*</span>to_send <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> data_send <span style=color:#f92672>*</span>)events[i].data.ptr;
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>write</span>(to_send<span style=color:#f92672>-&gt;</span>fd, to_send<span style=color:#f92672>-&gt;</span>buff, to_send<span style=color:#f92672>-&gt;</span>len);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (to_send<span style=color:#f92672>-&gt;</span>flag <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>close</span>(to_send<span style=color:#f92672>-&gt;</span>fd);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					event.data.fd <span style=color:#f92672>=</span> to_send<span style=color:#f92672>-&gt;</span>fd;
</span></span><span style=display:flex><span>					event.events <span style=color:#f92672>=</span> EPOLLIN <span style=color:#f92672>|</span> EPOLLET;
</span></span><span style=display:flex><span>					s <span style=color:#f92672>=</span> <span style=color:#a6e22e>epoll_ctl</span>(efd, EPOLL_CTL_MOD, to_send<span style=color:#f92672>-&gt;</span>fd, <span style=color:#f92672>&amp;</span>event);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;epoll_ctl&#34;</span>);
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>free</span>(events);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close</span>(sfd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> EXIT_SUCCESS;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=应用逻辑层>应用逻辑层</h2><h3 id=windows平台相关的变量声明>Windows平台相关的变量声明</h3><p>HANDLE 包括线程和数据库相关的变量，需要一一对应。其余的可以直接替换或<code>typedef</code>重定义。
<code>typedef unsinged long DWORD</code></p><h3 id=windows服务----linux服务>Windows服务 &ndash;> Linux服务</h3><p>编写相关Shell文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#description: example </span>
</span></span><span style=display:flex><span>export ORACLE_SID<span style=color:#f92672>=</span>orcl
</span></span><span style=display:flex><span>export ORACLE_PID<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>ps -ef|grep ora|grep -E <span style=color:#e6db74>&#39;smon|pmon|ckpt&#39;</span>|wc -l<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>export ORACLE_BASE<span style=color:#f92672>=</span>/u01/app
</span></span><span style=display:flex><span>export ORACLE_HOME<span style=color:#f92672>=</span>/u01/app/oracle
</span></span><span style=display:flex><span>export PATH<span style=color:#f92672>=</span>$PATH:$ORACLE_HOME/bin
</span></span><span style=display:flex><span>ORA_OWNR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;oracle&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f $ORACLE_HOME/bin/dbstart -o ! -d $ORACLE_HOME <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>   echo <span style=color:#e6db74>&#34;Oracle startup:can&#39;t start&#34;</span>
</span></span><span style=display:flex><span>   exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> in
</span></span><span style=display:flex><span>  start<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  echo -n <span style=color:#e6db74>&#34;Starting Oracle:&#34;</span>
</span></span><span style=display:flex><span>  su - $ORA_OWNR -c <span style=color:#e6db74>&#34;</span>$ORACLE_HOME<span style=color:#e6db74>/bin/dbstart&#34;</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;OK&#34;</span>
</span></span><span style=display:flex><span>  ;;
</span></span><span style=display:flex><span>  stop<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  echo -n <span style=color:#e6db74>&#34;Shutdown Oracle:&#34;</span>
</span></span><span style=display:flex><span>  su - $ORA_OWNR -c <span style=color:#e6db74>&#34;</span>$ORACLE_HOME<span style=color:#e6db74>/bin/dbshut&#34;</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;OK&#34;</span>
</span></span><span style=display:flex><span>  ;;
</span></span><span style=display:flex><span>  status<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $ORACLE_PID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3&#34;</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>     echo <span style=color:#e6db74>&#34;Oracle Instance is running...&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span> echo <span style=color:#e6db74>&#34;Oracle Instance is not running...&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>  ;;
</span></span><span style=display:flex><span>  restart<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  $0 stop
</span></span><span style=display:flex><span>  $0 start
</span></span><span style=display:flex><span>  ;;
</span></span><span style=display:flex><span>  *<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;Usage:`basename </span>$0<span style=color:#e6db74>` start|stop|status|restart&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span>exit $?
</span></span></code></pre></div><h3 id=windows网络库相关----linux-socket>Windows网络库相关 &ndash;> Linux Socket</h3><p>客户端代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​```</span>cpp
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Filename:  client.c
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *    Description:  client example
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Version:  1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Created:  11/10/2016 11:03:37 PM
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Revision:  none
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Compiler:  gcc
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Author:  CaiSong (), cais.fnst@cn.fujitsu.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Company:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;netinet/in.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * ===  FUNCTION  ======================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Name:  main
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  Description:
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAXLINE 4096
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> sockaddr_in servaddr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>servIP <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;192.168.220.128&#34;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> sockfd;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> sendLine[MAXLINE] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> recvLine[MAXLINE] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> rec_len <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ((sockfd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;create socket error:%s (errno: %d )</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno), errno);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>servaddr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(servaddr));
</span></span><span style=display:flex><span>	servaddr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>	servaddr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(<span style=color:#ae81ff>43388</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>inet_pton</span>(AF_INET, servIP, <span style=color:#f92672>&amp;</span>servaddr.sin_addr) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;inet_pton error for %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, servIP);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>connect</span>(sockfd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>servaddr, <span style=color:#66d9ef>sizeof</span>(servaddr)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;connect error :%s (errno: %d)&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno), errno);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;send message to server</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fgets</span>(sendLine, <span style=color:#ae81ff>4096</span>, stdin);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>send</span>(sockfd, sendLine, <span style=color:#a6e22e>strlen</span>(sendLine), <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;send msg error:%s, (errno :%d)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno), errno);
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> ((rec_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recv</span>(sockfd, recvLine, MAXLINE, <span style=color:#ae81ff>0</span>)) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;recv error&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		recvLine[rec_len] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;server :%s </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, recvLine);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close</span>(sockfd);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;client offline</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>} <span style=color:#75715e>/* ----------  end of function main  ---------- */</span>
</span></span></code></pre></div><p>服务器端代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Filename:  epollEx.c
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *    Description:  epoll example
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Version:  1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Created:  11/10/2016 10:15:10 PM
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Revision:  none
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Compiler:  gcc
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Author:  CaiSong (), cais.fnst@cn.fujitsu.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Company:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;netdb.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/epoll.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAXEVENTS 64
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>data_send</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> fd;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>buff;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> len;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> flag;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>make_socket_non_blocking</span>(<span style=color:#66d9ef>int</span> sfd)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> flags, s;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	flags <span style=color:#f92672>=</span> fcntl(sfd, F_GETFL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (flags <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		perror(<span style=color:#e6db74>&#34;fcntl&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	flags <span style=color:#f92672>|=</span> O_NONBLOCK;
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> fcntl(sfd, F_SETFL, flags);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		perror(<span style=color:#e6db74>&#34;fcntl&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>create_and_bind</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>port)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>addrinfo</span> hints;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>addrinfo</span> <span style=color:#f92672>*</span>result, <span style=color:#f92672>*</span>rp;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> s, sfd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	memset(<span style=color:#f92672>&amp;</span>hints, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>addrinfo</span>));
</span></span><span style=display:flex><span>	hints.ai_family <span style=color:#f92672>=</span> AF_UNSPEC;     <span style=color:#75715e>/* Return IPv4 and IPv6 choices */</span>
</span></span><span style=display:flex><span>	hints.ai_socktype <span style=color:#f92672>=</span> SOCK_STREAM; <span style=color:#75715e>/* We want a TCP socket */</span>
</span></span><span style=display:flex><span>	hints.ai_flags <span style=color:#f92672>=</span> AI_PASSIVE;     <span style=color:#75715e>/* All interfaces */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> getaddrinfo(NULL, port, <span style=color:#f92672>&amp;</span>hints, <span style=color:#f92672>&amp;</span>result);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		fprintf(stderr, <span style=color:#e6db74>&#34;getaddrinfo: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, gai_strerror(s));
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (rp <span style=color:#f92672>=</span> result; rp <span style=color:#f92672>!=</span> NULL; rp <span style=color:#f92672>=</span> rp<span style=color:#f92672>-&gt;</span>ai_next)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		sfd <span style=color:#f92672>=</span> socket(rp<span style=color:#f92672>-&gt;</span>ai_family, rp<span style=color:#f92672>-&gt;</span>ai_socktype, rp<span style=color:#f92672>-&gt;</span>ai_protocol);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (sfd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		s <span style=color:#f92672>=</span> bind(sfd, rp<span style=color:#f92672>-&gt;</span>ai_addr, rp<span style=color:#f92672>-&gt;</span>ai_addrlen);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#75715e>/* We managed to bind successfully! */</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		close(sfd);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (rp <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		fprintf(stderr, <span style=color:#e6db74>&#34;Could not bind</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	freeaddrinfo(result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> sfd;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> sfd, s;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> efd;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>data_send</span> <span style=color:#f92672>*</span>data;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>epoll_event</span> event;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>epoll_event</span> <span style=color:#f92672>*</span>events;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//if (argc != 2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//{
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//    fprintf(stderr, &#34;Usage: %s [port]\n&#34;, argv[0]);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//    exit(EXIT_FAILURE);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	sfd <span style=color:#f92672>=</span> create_and_bind(<span style=color:#e6db74>&#34;43388&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (sfd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) abort();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> make_socket_non_blocking(sfd);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) abort();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> listen(sfd, SOMAXCONN);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		perror(<span style=color:#e6db74>&#34;listen&#34;</span>);
</span></span><span style=display:flex><span>		abort();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	efd <span style=color:#f92672>=</span> epoll_create1(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (efd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		perror(<span style=color:#e6db74>&#34;epoll_create&#34;</span>);
</span></span><span style=display:flex><span>		abort();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	event.data.fd <span style=color:#f92672>=</span> sfd;
</span></span><span style=display:flex><span>	event.events <span style=color:#f92672>=</span> EPOLLIN <span style=color:#f92672>|</span> EPOLLET;
</span></span><span style=display:flex><span>	s <span style=color:#f92672>=</span> epoll_ctl(efd, EPOLL_CTL_ADD, sfd, <span style=color:#f92672>&amp;</span>event);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		perror(<span style=color:#e6db74>&#34;epoll_ctl&#34;</span>);
</span></span><span style=display:flex><span>		abort();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* Buffer where events are returned */</span>
</span></span><span style=display:flex><span>	events <span style=color:#f92672>=</span> calloc(MAXEVENTS, <span style=color:#66d9ef>sizeof</span> event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* The event loop */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> n, i;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		n <span style=color:#f92672>=</span> epoll_wait(efd, events, MAXEVENTS, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> n; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> ((events[i].events <span style=color:#f92672>&amp;</span> EPOLLERR) <span style=color:#f92672>||</span> (events[i].events <span style=color:#f92672>&amp;</span> EPOLLHUP) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>				(<span style=color:#f92672>!</span>(events[i].events <span style=color:#f92672>&amp;</span> EPOLLIN <span style=color:#f92672>||</span> events[i].events <span style=color:#f92672>&amp;</span> EPOLLOUT)))
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#75715e>/* An error has occured on this fd, or the socket is not
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   ready for reading (why were we notified then?) */</span>
</span></span><span style=display:flex><span>				fprintf(stderr, <span style=color:#e6db74>&#34;epoll error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>				close(events[i].data.fd);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (sfd <span style=color:#f92672>==</span> events[i].data.fd)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#75715e>/* We have a notification on the listening socket, which
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   means one or more incoming connections. */</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sockaddr</span> in_addr;
</span></span><span style=display:flex><span>					socklen_t in_len;
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>int</span> infd;
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>char</span> hbuf[NI_MAXHOST], sbuf[NI_MAXSERV];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					in_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span> in_addr;
</span></span><span style=display:flex><span>					infd <span style=color:#f92672>=</span> accept(sfd, <span style=color:#f92672>&amp;</span>in_addr, <span style=color:#f92672>&amp;</span>in_len);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (infd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>if</span> ((errno <span style=color:#f92672>==</span> EAGAIN) <span style=color:#f92672>||</span> (errno <span style=color:#f92672>==</span> EWOULDBLOCK))
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							<span style=color:#75715e>/* We have processed all incoming
</span></span></span><span style=display:flex><span><span style=color:#75715e>							   connections. */</span>
</span></span><span style=display:flex><span>							<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							perror(<span style=color:#e6db74>&#34;accept&#34;</span>);
</span></span><span style=display:flex><span>							<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					s <span style=color:#f92672>=</span> getnameinfo(<span style=color:#f92672>&amp;</span>in_addr, in_len, hbuf, <span style=color:#66d9ef>sizeof</span> hbuf, sbuf, <span style=color:#66d9ef>sizeof</span> sbuf,
</span></span><span style=display:flex><span>									NI_NUMERICHOST <span style=color:#f92672>|</span> NI_NUMERICSERV);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						printf(
</span></span><span style=display:flex><span>							<span style=color:#e6db74>&#34;Accepted connection on descriptor %d &#34;</span>
</span></span><span style=display:flex><span>							<span style=color:#e6db74>&#34;(host=%s, port=%s)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>							infd, hbuf, sbuf);
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>/* Make the incoming socket non-blocking and add it to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>					   list of fds to monitor. */</span>
</span></span><span style=display:flex><span>					s <span style=color:#f92672>=</span> make_socket_non_blocking(infd);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) abort();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					event.data.fd <span style=color:#f92672>=</span> infd;
</span></span><span style=display:flex><span>					event.events <span style=color:#f92672>=</span> EPOLLIN <span style=color:#f92672>|</span> EPOLLET;
</span></span><span style=display:flex><span>					s <span style=color:#f92672>=</span> epoll_ctl(efd, EPOLL_CTL_ADD, infd, <span style=color:#f92672>&amp;</span>event);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						perror(<span style=color:#e6db74>&#34;epoll_ctl&#34;</span>);
</span></span><span style=display:flex><span>						abort();
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (events[i].events <span style=color:#f92672>&amp;</span> EPOLLIN)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#75715e>/* We have data on the fd waiting to be read. Read and
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   display it. We must read whatever data is available
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   completely, as we are running in edge-triggered mode
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   and won&#39;t get a notification again for the same
</span></span></span><span style=display:flex><span><span style=color:#75715e>				   data. */</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					ssize_t count;
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>512</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>					fd <span style=color:#f92672>=</span> events[i].data.fd;
</span></span><span style=display:flex><span>					count <span style=color:#f92672>=</span> read(fd, buf, <span style=color:#66d9ef>sizeof</span> buf);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (count <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#75715e>/* If errno == EAGAIN, that means we have read all
</span></span></span><span style=display:flex><span><span style=color:#75715e>						   data. So go back to the main loop. */</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>if</span> (errno <span style=color:#f92672>!=</span> EAGAIN)
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							perror(<span style=color:#e6db74>&#34;read&#34;</span>);
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (count <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#75715e>/* End of file. The remote has closed the
</span></span></span><span style=display:flex><span><span style=color:#75715e>						   connection. */</span>
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>/* Write the buffer to standard output */</span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>// strcpy(recv, &#34;client: &#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// strcat(recv, buf);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// s = write(1, recv, strlen(recv));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// if (s == -1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>//{
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>//    perror(&#34;write&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>//    abort();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>//}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// strcpy(buf, &#34;hello, client&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#75715e>// write(events[i].data.fd, buf, strlen(buf));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>					write(STDOUT_FILENO, buf, strlen(buf));
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				data <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>data_send</span> <span style=color:#f92672>*</span>)malloc(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>data_send</span>));
</span></span><span style=display:flex><span>				memset(data, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>data_send</span>));
</span></span><span style=display:flex><span>				data<span style=color:#f92672>-&gt;</span>fd <span style=color:#f92672>=</span> fd;
</span></span><span style=display:flex><span>				event.data.ptr <span style=color:#f92672>=</span> data;
</span></span><span style=display:flex><span>				event.events <span style=color:#f92672>=</span> EPOLLOUT <span style=color:#f92672>|</span> EPOLLET;
</span></span><span style=display:flex><span>				s <span style=color:#f92672>=</span> epoll_ctl(efd, EPOLL_CTL_MOD, fd, <span style=color:#f92672>&amp;</span>event);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					perror(<span style=color:#e6db74>&#34;epoll_ctl&#34;</span>);
</span></span><span style=display:flex><span>					abort();
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				data<span style=color:#f92672>-&gt;</span>buff <span style=color:#f92672>=</span> malloc(<span style=color:#ae81ff>64</span>);
</span></span><span style=display:flex><span>				strcpy(data<span style=color:#f92672>-&gt;</span>buff, <span style=color:#e6db74>&#34;hello&#34;</span>);
</span></span><span style=display:flex><span>				data<span style=color:#f92672>-&gt;</span>len <span style=color:#f92672>=</span> strlen(data<span style=color:#f92672>-&gt;</span>buff);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (events[i].events <span style=color:#f92672>&amp;</span> EPOLLOUT)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>data_send</span> <span style=color:#f92672>*</span>to_send <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>data_send</span> <span style=color:#f92672>*</span>)events[i].data.ptr;
</span></span><span style=display:flex><span>				write(to_send<span style=color:#f92672>-&gt;</span>fd, to_send<span style=color:#f92672>-&gt;</span>buff, to_send<span style=color:#f92672>-&gt;</span>len);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (to_send<span style=color:#f92672>-&gt;</span>flag <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					close(to_send<span style=color:#f92672>-&gt;</span>fd);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					event.data.fd <span style=color:#f92672>=</span> to_send<span style=color:#f92672>-&gt;</span>fd;
</span></span><span style=display:flex><span>					event.events <span style=color:#f92672>=</span> EPOLLIN <span style=color:#f92672>|</span> EPOLLET;
</span></span><span style=display:flex><span>					s <span style=color:#f92672>=</span> epoll_ctl(efd, EPOLL_CTL_MOD, to_send<span style=color:#f92672>-&gt;</span>fd, <span style=color:#f92672>&amp;</span>event);
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						perror(<span style=color:#e6db74>&#34;epoll_ctl&#34;</span>);
</span></span><span style=display:flex><span>						abort();
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	free(events);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	close(sfd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> EXIT_SUCCESS;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=配置文件及xml文件解析>配置文件及xml文件解析</h3><p>目前使用windows系统函数解析ini文件，之前发布的Linux版中间件中ini解析对gcc版本要求太高，目前Centos 7 不支持。
可选方案：
目前使用多次读取ini文件的方式，按需获取配置文件中相关信息。Linux平台下ini文件解析器可以使用开源库<code>iniparser</code>或自己实现。使用xml方式定义配置文件，文件结构清晰，仅加载一次配置文件实现整体解析，开源库众多，如<code>libxml2</code>,<code>tinyxml</code>等，且<strong>分析业务中获取地址需要解析xml格式内容</strong></p><table><thead><tr><th style=text-align:left>类型</th><th style=text-align:center>ini</th><th style=text-align:center>xml</th></tr></thead><tbody><tr><td style=text-align:left>优点</td><td style=text-align:center>代码改动量小</td><td style=text-align:center>结构清晰，效率高</td></tr><tr><td style=text-align:left>缺点</td><td style=text-align:center>效率低</td><td style=text-align:center>代码改动大</td></tr><tr><td style=text-align:left>部分xml配置文件示例</td><td></td><td></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;root&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;server</span> <span style=color:#a6e22e>kind=</span><span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#a6e22e>port=</span><span style=color:#e6db74>&#34;43388&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;wifi</span> <span style=color:#a6e22e>enable=</span><span style=color:#e6db74>&#34;false&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;companycode/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;filePath&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;path</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;carsettingmanagement&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;carsettingmanagement&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;path</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;parameter&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;parameterset&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;path</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;outdata&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;DataFile&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;path</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;difffile&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;DiffFile&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;path</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;userfile&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;UserFile&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;path</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;carlog&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;CarLogFile&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/filePath&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;DBInfo&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;info</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;connDBInfo&#34;</span> <span style=color:#a6e22e>addr=</span><span style=color:#e6db74>&#34;10.167.218.27&#34;</span><span style=color:#a6e22e>userName=</span><span style=color:#e6db74>&#34;sa&#34;</span> <span style=color:#a6e22e>password=</span><span style=color:#e6db74>&#34;Sa123456&#34;</span> <span style=color:#a6e22e>dbName=</span><span style=color:#e6db74>&#34;INFOMANAGEMENT_DB&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;info</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;V1DB&#34;</span> <span style=color:#a6e22e>addr=</span><span style=color:#e6db74>&#34;10.167.218.27&#34;</span><span style=color:#a6e22e>userName=</span><span style=color:#e6db74>&#34;sa&#34;</span> <span style=color:#a6e22e>password=</span><span style=color:#e6db74>&#34;Sa123456&#34;</span> <span style=color:#a6e22e>dbName=</span><span style=color:#e6db74>&#34;INFOMANAGEMENT_DB&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/DBInfo&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;CarFirmCheck&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;version&gt;</span>31030101<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;version&gt;</span>21030413<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;version&gt;</span>32030108<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/CarFirmCheck&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/root&gt;</span>
</span></span></code></pre></div><h3 id=文件相关>文件相关</h3><table><thead><tr><th style=text-align:left>windows</th><th style=text-align:left>Linux</th></tr></thead><tbody><tr><td style=text-align:left>CreateFile</td><td style=text-align:left>open</td></tr><tr><td style=text-align:left>DeleteFile</td><td style=text-align:left>remove</td></tr><tr><td style=text-align:left>ReadFile</td><td style=text-align:left>read</td></tr><tr><td style=text-align:left>WriteFile</td><td style=text-align:left>write</td></tr><tr><td style=text-align:left>CreateDirectoryFindFirstFile</td><td style=text-align:left>kdiropendirclosedir</td></tr><tr><td style=text-align:left>GetFileSizeGetFileTime</td><td style=text-align:left>fstat</td></tr><tr><td style=text-align:left>GetModuleFileName</td><td style=text-align:left>getcwd</td></tr><tr><td style=text-align:left>GetFirstFile</td><td style=text-align:left>file_exists</td></tr><tr><td style=text-align:left>CloseHandle</td><td style=text-align:left>close</td></tr><tr><td style=text-align:left>SetFilePointer</td><td style=text-align:left>lseek</td></tr></tbody></table><h3 id=eslc压缩库>Eslc压缩库</h3><p>目前使用的是dll库，需要日方提供Linux版本
动态库调用</p><table><thead><tr><th style=text-align:left>Windows</th><th style=text-align:left>Linux</th></tr></thead><tbody><tr><td style=text-align:left>LoadLibrary</td><td style=text-align:left>dlopen</td></tr><tr><td style=text-align:left>GetProcAddress</td><td style=text-align:left>dlsym</td></tr><tr><td style=text-align:left>FreeLibrary</td><td style=text-align:left>dlclose</td></tr><tr><td style=text-align:left></td><td style=text-align:left>dlerror</td></tr></tbody></table><h3 id=日志>日志</h3><p>日志配置文件
支持日志分级、文件输出、格式定义等常见功能。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE log4c SYSTEM &#34;&#34;&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;log4c</span> <span style=color:#a6e22e>version=</span><span style=color:#e6db74>&#34;1.2.4&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;config&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;bufsize&gt;</span>0<span style=color:#f92672>&lt;/bufsize&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;debug</span> <span style=color:#a6e22e>level=</span><span style=color:#e6db74>&#34;0&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;nocleanup&gt;</span>1<span style=color:#f92672>&lt;/nocleanup&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;reread&gt;</span>1<span style=color:#f92672>&lt;/reread&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;/config&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;category</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;root&#34;</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;notice&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;category</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;myapp&#34;</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;debug&#34;</span> <span style=color:#a6e22e>appender=</span><span style=color:#e6db74>&#34;myfile&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;appender</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;myfile&#34;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;rollingfile&#34;</span> <span style=color:#a6e22e>logdir=</span><span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#a6e22e>prefix=</span><span style=color:#e6db74>&#34;commdl&#34;</span> <span style=color:#a6e22e>layout=</span><span style=color:#e6db74>&#34;dated&#34;</span> <span style=color:#a6e22e>rollingpolicy=</span><span style=color:#e6db74>&#34;myrollingpolicy&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;rollingpolicy</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;myrollingpolicy&#34;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;sizewin&#34;</span> <span style=color:#a6e22e>maxsize=</span><span style=color:#e6db74>&#34;1024000&#34;</span> <span style=color:#a6e22e>maxnum=</span><span style=color:#e6db74>&#34;10&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;layout</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;dated&#34;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;dated&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/log4c&gt;</span>
</span></span></code></pre></div><p>使用示例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Filename:  logTest.c
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *    Description:  log4c example
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Version:  1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Created:  11/10/2016 12:16:45 AM
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Revision:  none
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Compiler:  gcc
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Author:  CaiSong (), cais.fnst@cn.fujitsu.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Company:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef HAVE_CONFIG_H
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;config.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;log4c.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> rc <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>log4c_category_t</span><span style=color:#f92672>*</span> mycat <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>log4c_init</span>())
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;log4c_init() failed&#34;</span>);
</span></span><span style=display:flex><span>		rc <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		mycat <span style=color:#f92672>=</span> <span style=color:#a6e22e>log4c_category_get</span>(<span style=color:#e6db74>&#34;myapp&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log4c_category_log</span>(mycat, LOG4C_PRIORITY_ERROR, <span style=color:#e6db74>&#34;Hello World!&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* Explicitly call the log4c cleanup routine */</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>log4c_fini</span>())
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;log4c_fini() failed&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> rc;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=windows共享内存>windows共享内存</h3><table><thead><tr><th style=text-align:left>Windows</th><th style=text-align:left>Linux</th><th style=text-align:left>Classification</th></tr></thead><tbody><tr><td style=text-align:left>CreateFileMaping()</td><td style=text-align:left>shm_open()</td><td style=text-align:left>Context</td></tr><tr><td style=text-align:left>MapViewOfFile()</td><td style=text-align:left>mmap()</td><td style=text-align:left>Context</td></tr><tr><td style=text-align:left>UnampViewOfFile()</td><td style=text-align:left>munmap()</td><td style=text-align:left>Context</td></tr></tbody></table><h3 id=线程-事件-互斥量-临界区-信号量>线程 事件 互斥量 临界区 信号量</h3><p>进程映射</p><table><thead><tr><th style=text-align:left>Windows</th><th style=text-align:left>Linux</th><th style=text-align:left>Classification</th></tr></thead><tbody><tr><td style=text-align:left>CreateProcess()CreateProcessAsUser()</td><td style=text-align:left>fork()setuid()exec()</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>TerminateProcess()</td><td style=text-align:left>kill()</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>SetThreadpriority()GetThreadPriority()</td><td style=text-align:left>setPriority()getPriority()</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>GetCurrentProcessID()</td><td style=text-align:left>getpid()</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>Exitprocess()</td><td style=text-align:left>exit()</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>Waitforsingleobject()Waitformultipleobject()GetExitCodeProcess()</td><td style=text-align:left>waitpid()Using sys V semaphores, waitforsingleobject/multiobject不能实现</td><td style=text-align:left>Context</td></tr><tr><td style=text-align:left>GetEnvironmentVariableSetEnvironmentVariable</td><td style=text-align:left>getenv()setenv()</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>线程映射</td><td></td><td></td></tr><tr><td style=text-align:left>Windows</td><td style=text-align:left>Linux</td><td style=text-align:left>Classification</td></tr><tr><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;-</td></tr><tr><td style=text-align:left>CreateThread</td><td style=text-align:left>pthread_createpthread_attr_initpthread_attr_setstacksizepthread_attr_destory</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>ThreadExit</td><td style=text-align:left>pthread_exit</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>WaitForSingleObject</td><td style=text-align:left>pthread_joinpthread_attr_setdetachstatepthread_detach</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>SetpriorityClassSetThreadPriority</td><td style=text-align:left>setprioritysched_setschedulersched_setparampthread_setschedparampthread_setschedpolicypthread_attr_setschedparampthread_attr_setschedpolicy</td><td style=text-align:left>Context</td></tr><tr><td style=text-align:left>事件</td><td></td><td></td></tr><tr><td style=text-align:left>Windows</td><td style=text-align:left>Linux(thread)</td><td style=text-align:left>Linux(process)</td></tr><tr><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;-</td></tr><tr><td style=text-align:left>CreateEventOpenEvent</td><td style=text-align:left>pthread_cond_initsem_init</td><td style=text-align:left>semgetsemctl</td></tr><tr><td style=text-align:left>SetEvent</td><td style=text-align:left>pthread_cond_signalsem_post</td><td style=text-align:left>semop</td></tr><tr><td style=text-align:left>ResetEvent</td><td style=text-align:left>N/A</td><td style=text-align:left>N/A</td></tr><tr><td style=text-align:left>WaifForSingleobject</td><td style=text-align:left>pthread_cond_waitpthread_cond_timedwaitsem_waitsem_trywait</td><td style=text-align:left>semop</td></tr><tr><td style=text-align:left>CloseHandle</td><td style=text-align:left>pthread_cond_destorysem_destroy</td><td style=text-align:left>semctl</td></tr><tr><td style=text-align:left>互斥量</td><td></td><td></td></tr><tr><td style=text-align:left>Windows</td><td style=text-align:left>Linux(thread)</td><td style=text-align:left>Linux(process)</td></tr><tr><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;-</td></tr><tr><td style=text-align:left>CreateMutex</td><td style=text-align:left>pthreads_mutex_init</td><td style=text-align:left>semgetsemctl</td></tr><tr><td style=text-align:left>OpenMutex</td><td style=text-align:left>N/A</td><td style=text-align:left>semget</td></tr><tr><td style=text-align:left>WaifForSingleObject</td><td style=text-align:left>pthread_mutex_lockpthread_mutex_unlock</td><td style=text-align:left>semop</td></tr><tr><td style=text-align:left>ReleaseMutex</td><td style=text-align:left>pthread_mutex_unlock</td><td style=text-align:left>semop</td></tr><tr><td style=text-align:left>CloseHandle</td><td style=text-align:left>pthread_mutex_destroy</td><td style=text-align:left>semctl</td></tr><tr><td style=text-align:left>SignalObjectAndWait</td><td style=text-align:left>semop</td><td style=text-align:left>semop</td></tr><tr><td style=text-align:left>WaitForMultipleObjects</td><td style=text-align:left>sem_waitsem_trywait</td><td style=text-align:left>semop</td></tr><tr><td style=text-align:left>临界区</td><td></td><td></td></tr><tr><td style=text-align:left>Windows</td><td style=text-align:left>Linux</td><td style=text-align:left>Classification</td></tr><tr><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;-</td></tr><tr><td style=text-align:left>InitializeCriticalSectionInitializeCriticalSectionAndSpinCount</td><td style=text-align:left>pthreads_mutex_init</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>EnterCriticalSectionTryEnterCriticalSection</td><td style=text-align:left>pthread_mutex_lock pthread_mutex_trylock</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>LeaveCriticalSection</td><td style=text-align:left>pthread_mutex_unlock</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>DeleteCriticalSection</td><td style=text-align:left>pthread_mutex_destroy</td><td style=text-align:left>Mappable</td></tr><tr><td style=text-align:left>信号量</td><td></td><td></td></tr><tr><td style=text-align:left>Windows</td><td style=text-align:left>Linux(thread)</td><td style=text-align:left>Linux(process)</td></tr><tr><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</td><td style=text-align:left>:&mdash;&mdash;&mdash;&mdash;&mdash;</td></tr><tr><td style=text-align:left>CreateSemaphore</td><td style=text-align:left>sem_init</td><td style=text-align:left>semgetsemctl</td></tr><tr><td style=text-align:left>OpenSemaphore</td><td style=text-align:left>N/A</td><td style=text-align:left>semget</td></tr><tr><td style=text-align:left>WaitForSingleObject</td><td style=text-align:left>sem_waitsem_trywait</td><td style=text-align:left>semop</td></tr><tr><td style=text-align:left>ReleaseSemaphore</td><td style=text-align:left>sem_post</td><td style=text-align:left>semop</td></tr><tr><td style=text-align:left>CloseHandle</td><td style=text-align:left>sem_destroy</td><td style=text-align:left>semctl</td></tr><tr><td style=text-align:left>线程相关Example</td><td></td><td></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *       Filename:  shmExample.c
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *    Description:  shared memeory example
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *        Version:  1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *        Created:  11/10/2016 01:33:33 AM
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *       Revision:  none
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *       Compiler:  gcc
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *         Author:  CaiSong (), cais.fnst@cn.fujitsu.com
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *        Company:
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/mman.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/stat.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * ===  FUNCTION  ======================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *         Name:  main
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *  Description:
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#define FILE_MODE (S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define SHM_NAME &#34;myshm&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>pthread_mutex_t</span> mutex;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>pthread_cond_t</span> cond;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shm_write</span>()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> i, fd;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> stat stat;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>ptr;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write thread acquire lock</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_mutex_lock</span>(<span style=color:#f92672>&amp;</span>mutex);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write thread get lock</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>shm_open</span>(SHM_NAME, O_RDWR, FILE_MODE);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fstat</span>(fd, <span style=color:#f92672>&amp;</span>stat);
</span></span><span style=display:flex><span>		ptr <span style=color:#f92672>=</span> <span style=color:#a6e22e>mmap</span>(NULL, stat.st_size, PROT_READ <span style=color:#f92672>|</span> PROT_WRITE, MAP_SHARED, fd, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>close</span>(fd);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> stat.st_size; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#f92672>*</span>ptr<span style=color:#f92672>++</span> <span style=color:#f92672>=</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>256</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write thread release lock</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_mutex_unlock</span>(<span style=color:#f92672>&amp;</span>mutex);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write thread signal cond</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_cond_signal</span>(<span style=color:#f92672>&amp;</span>cond);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shm_read</span>()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> i, fd;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> stat stat;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> c, <span style=color:#f92672>*</span>ptr;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read thread acquire lock</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_mutex_lock</span>(<span style=color:#f92672>&amp;</span>mutex);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read release lock</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_cond_wait</span>(<span style=color:#f92672>&amp;</span>cond, <span style=color:#f92672>&amp;</span>mutex);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read cond satisfy</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>shm_open</span>(SHM_NAME, O_RDONLY, FILE_MODE);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fstat</span>(fd, <span style=color:#f92672>&amp;</span>stat);
</span></span><span style=display:flex><span>		ptr <span style=color:#f92672>=</span> <span style=color:#a6e22e>mmap</span>(NULL, stat.st_size, PROT_READ, MAP_SHARED, fd, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>close</span>(fd);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> stat.st_size; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> ((c <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>!=</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>256</span>)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#75715e>// fprintf(stderr, &#34;ptr[%d] = %d\r\n&#34;, i, c);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>pthread_mutex_unlock</span>(<span style=color:#f92672>&amp;</span>mutex);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>/*  else
</span></span></span><span style=display:flex><span><span style=color:#75715e>			{
</span></span></span><span style=display:flex><span><span style=color:#75715e>				fprintf(stdout, &#34;ptr[%d] = %d\r\n&#34;, i, c);
</span></span></span><span style=display:flex><span><span style=color:#75715e>				}*/</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fprintf</span>(stdout, <span style=color:#e6db74>&#34;ptr[100] = %d</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>+</span><span style=color:#ae81ff>100</span>));
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_mutex_unlock</span>(<span style=color:#f92672>&amp;</span>mutex);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;exit</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> fd;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int</span> flags;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>off_t</span> length;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>ptr;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>pthread_t</span> pt1, pt2;
</span></span><span style=display:flex><span>		flags <span style=color:#f92672>=</span> O_RDWR <span style=color:#f92672>|</span> O_CREAT;
</span></span><span style=display:flex><span>		length <span style=color:#f92672>=</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>		fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>shm_open</span>(SHM_NAME, flags, FILE_MODE);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ftruncate</span>(fd, length);
</span></span><span style=display:flex><span>		ptr <span style=color:#f92672>=</span> <span style=color:#a6e22e>mmap</span>(NULL, length, PROT_READ <span style=color:#f92672>|</span> PROT_WRITE, MAP_SHARED, fd, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_mutex_init</span>(<span style=color:#f92672>&amp;</span>mutex, NULL);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_cond_init</span>(<span style=color:#f92672>&amp;</span>cond, NULL);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_create</span>(<span style=color:#f92672>&amp;</span>pt1, NULL, shm_read, NULL);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_create</span>(<span style=color:#f92672>&amp;</span>pt2, NULL, shm_write, NULL);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_join</span>(pt1, NULL);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_join</span>(pt2, NULL);
</span></span><span style=display:flex><span>		<span style=color:#75715e>// shm_write();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// shm_read();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>pthread_cond_destroy</span>(<span style=color:#f92672>&amp;</span>cond);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pthread_mutex_destroy</span>(<span style=color:#f92672>&amp;</span>mutex);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>munmap</span>(ptr, length);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>shm_unlink</span>(SHM_NAME);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	} <span style=color:#75715e>/* ----------  end of function main  ---------- */</span>
</span></span></code></pre></div><h3 id=进程内存控制>进程内存控制</h3><table><thead><tr><th style=text-align:left>Function</th><th style=text-align:left>Platform</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>SetProcessWorkingSetSizeGetProcessWorkingSetSize</td><td style=text-align:left>Windows</td><td style=text-align:left>Sets/get the minimum and maximum working set sizes for the specified process</td></tr><tr><td style=text-align:left>brksbrk</td><td style=text-align:left>Linux</td><td style=text-align:left>change data segment size</td></tr><tr><td style=text-align:left>setrlimitgetrlimit</td><td style=text-align:left>Linux</td><td style=text-align:left>get/set resource limits</td></tr></tbody></table><h3 id=其他系统函数对应>其他系统函数对应</h3><table><thead><tr><th style=text-align:left>Category</th><th style=text-align:left>Windows</th><th style=text-align:left>Linux</th></tr></thead><tbody><tr><td style=text-align:left>Time</td><td style=text-align:left>GetLocalTimeFileTimeToLocalFileTimeFileTimeToSystemTimeGetTickCount</td><td style=text-align:left>localtimegettimeofdaygmtimeclock_gettime</td></tr><tr><td style=text-align:left>Memory</td><td style=text-align:left>FillMemoryZeroMemoryCopyMemoryMoveMemory</td><td style=text-align:left>memsetmemsetmemcpymemmove</td></tr><tr><td style=text-align:left>sys log</td><td style=text-align:left>RegisterEventSourceReportEventDeregisterEventSource</td><td style=text-align:left>openlogsyslogcloselog</td></tr><tr><td style=text-align:left>mem alloc</td><td style=text-align:left>GlobalAllocGlobalFree</td><td style=text-align:left>mallocfree</td></tr><tr><td style=text-align:left>sys error</td><td style=text-align:left>GetLastError</td><td style=text-align:left>strerrorerrno</td></tr><tr><td style=text-align:left>string</td><td style=text-align:left>StrToIntMultiByteToWideCharStringCchPrintf</td><td style=text-align:left>atoiiconvsprintf</td></tr></tbody></table><h3 id=wsawaitformultiobjects>WSAWaitForMultiObjects</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Filename:  waiForMulti.c
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *    Description:  wait for multi objects
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Version:  1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Created:  11/12/2016 12:21:09 AM
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Revision:  none
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Compiler:  gcc
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Author:  CaiSong (), cais.fnst@cn.fujitsu.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Company:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/sem.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/ipc.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SEM_R 0400  </span><span style=color:#75715e>//用户（属主）读
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SEM_A 0200  </span><span style=color:#75715e>//用户（属主）写
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SVSEM_MODE (SEM_R | SEM_A | SEM_R &gt;&gt; 3 | SEM_R &gt;&gt; 6)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> num <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>union</span> semun
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> val;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> semid_ds <span style=color:#f92672>*</span>buf;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span> <span style=color:#f92672>*</span>array;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>thread</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> semid;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>++</span>num <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, num);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	semid <span style=color:#f92672>=</span> <span style=color:#a6e22e>semget</span>(<span style=color:#a6e22e>ftok</span>(<span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#ae81ff>0</span>), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>0</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, SETVAL, <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;change over</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> i, ret, oflag, semid, nsems;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>pthread_t</span> pt1, pt2, pt3;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> sembuf <span style=color:#f92672>*</span>ops;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> semid_ds seminfo;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span> <span style=color:#f92672>*</span>ptr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>union</span> semun arg;
</span></span><span style=display:flex><span>	oflag <span style=color:#f92672>=</span> SVSEM_MODE <span style=color:#f92672>|</span> IPC_CREAT <span style=color:#f92672>|</span> IPC_EXCL;  <span style=color:#75715e>//设置创建模式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//创建信号量，通过ftok函数创建一个key，返回信号量 标识符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	nsems <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (semid <span style=color:#f92672>=</span> <span style=color:#a6e22e>semget</span>(<span style=color:#a6e22e>ftok</span>(<span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#ae81ff>0</span>), nsems, oflag) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (errno <span style=color:#f92672>==</span> EEXIST)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			semid <span style=color:#f92672>=</span> <span style=color:#a6e22e>semget</span>(<span style=color:#a6e22e>ftok</span>(<span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#ae81ff>0</span>), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>			arg.buf <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>seminfo;
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, IPC_STAT, arg);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	ptr <span style=color:#f92672>=</span> <span style=color:#a6e22e>calloc</span>(nsems, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span>));
</span></span><span style=display:flex><span>	ptr[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	arg.array <span style=color:#f92672>=</span> ptr;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, SETALL, arg);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, GETALL, arg);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> nsems; <span style=color:#f92672>++</span>i) <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i, arg.array[i]);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pthread_create</span>(<span style=color:#f92672>&amp;</span>pt1, NULL, <span style=color:#66d9ef>thread</span>, NULL);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pthread_create</span>(<span style=color:#f92672>&amp;</span>pt2, NULL, <span style=color:#66d9ef>thread</span>, NULL);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pthread_create</span>(<span style=color:#f92672>&amp;</span>pt3, NULL, <span style=color:#66d9ef>thread</span>, NULL);
</span></span><span style=display:flex><span>	ops <span style=color:#f92672>=</span> <span style=color:#a6e22e>calloc</span>(nsems, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> sembuf));
</span></span><span style=display:flex><span>	ops[<span style=color:#ae81ff>0</span>].sem_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	ops[<span style=color:#ae81ff>0</span>].sem_op <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	ops[<span style=color:#ae81ff>0</span>].sem_flg <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semop</span>(semid, ops, nsems);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>seminfo, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(seminfo));
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, GETALL, arg);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> nsems; <span style=color:#f92672>++</span>i) <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i, arg.array[i]);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Filename:  waiForMulti.c
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *    Description:  wait for multi objects
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Version:  1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Created:  11/12/2016 12:21:09 AM
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Revision:  none
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       Compiler:  gcc
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         Author:  CaiSong (), cais.fnst@cn.fujitsu.com
</span></span></span><span style=display:flex><span><span style=color:#75715e> *        Company:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * =====================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/sem.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/ipc.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SEM_R 0400  </span><span style=color:#75715e>//用户（属主）读
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SEM_A 0200  </span><span style=color:#75715e>//用户（属主）写
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SVSEM_MODE (SEM_R | SEM_A | SEM_R &gt;&gt; 3 | SEM_R &gt;&gt; 6)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> num <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>union</span> semun
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> val;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> semid_ds <span style=color:#f92672>*</span>buf;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span> <span style=color:#f92672>*</span>array;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>thread</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> semid;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>++</span>num <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>3</span>) {<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, num);<span style=color:#66d9ef>return</span>;}
</span></span><span style=display:flex><span>	semid <span style=color:#f92672>=</span> <span style=color:#a6e22e>semget</span>(<span style=color:#a6e22e>ftok</span>(<span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#ae81ff>0</span>), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>0</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, IPC_RMID))
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;change over</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> i, ret, oflag, semid, nsems;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>pthread_t</span> pt1, pt2, pt3;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> sembuf <span style=color:#f92672>*</span>ops;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> semid_ds seminfo;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span> <span style=color:#f92672>*</span>ptr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>union</span> semun arg;
</span></span><span style=display:flex><span>	oflag <span style=color:#f92672>=</span> SVSEM_MODE <span style=color:#f92672>|</span> IPC_CREAT <span style=color:#f92672>|</span> IPC_EXCL;  <span style=color:#75715e>//设置创建模式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//创建信号量，通过ftok函数创建一个key，返回信号量 标识符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	nsems <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>	semid <span style=color:#f92672>=</span> <span style=color:#a6e22e>semget</span>(<span style=color:#a6e22e>ftok</span>(<span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#ae81ff>0</span>), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	arg.buf <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>seminfo;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, IPC_STAT, arg);
</span></span><span style=display:flex><span>	ptr <span style=color:#f92672>=</span> <span style=color:#a6e22e>calloc</span>(nsems, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span>));
</span></span><span style=display:flex><span>	ptr[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	arg.array <span style=color:#f92672>=</span> ptr;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, SETALL, arg);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, GETALL, arg);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> nsems; <span style=color:#f92672>++</span>i) <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i, arg.array[i]);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pthread_create</span>(<span style=color:#f92672>&amp;</span>pt1, NULL, <span style=color:#66d9ef>thread</span>, NULL);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pthread_create</span>(<span style=color:#f92672>&amp;</span>pt2, NULL, <span style=color:#66d9ef>thread</span>, NULL);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pthread_create</span>(<span style=color:#f92672>&amp;</span>pt3, NULL, <span style=color:#66d9ef>thread</span>, NULL);
</span></span><span style=display:flex><span>	ops <span style=color:#f92672>=</span> <span style=color:#a6e22e>calloc</span>(nsems, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> sembuf));
</span></span><span style=display:flex><span>	ops[<span style=color:#ae81ff>0</span>].sem_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	ops[<span style=color:#ae81ff>0</span>].sem_op <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	ops[<span style=color:#ae81ff>0</span>].sem_flg <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semop</span>(semid, ops, nsems);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>seminfo, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(seminfo));
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semctl</span>(semid, <span style=color:#ae81ff>0</span>, GETALL, arg);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> nsems; <span style=color:#f92672>++</span>i) 
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i, arg.array[i]);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>等待多事件，所有的<code>WSAWaitForMultiObjects</code>函数都没有等待多个事件，除了程序继续运行的必要事件外，其他监视的是数据库写入、连接等异常事件。若数据库连接异常，可以在写DB出错被发现，非必须监视。其他写与网络相关的事件在<code>epoll</code>中被监视，其他线程可以不监听。</p><h2 id=数据缓存>数据缓存</h2><p>对于不经常修改的数据建议使用缓存，人为手动修改数据库，导致的异常不应该在考虑范围。对于通过ITP修改的数据，ITP在DB中添加相应修改记录，中间件通过扫描该表更新缓存。
a. 运用服务器监视线程：
* fn_App_CmdListenThd
cmd监视
* fn_App_CompanyInfoListenThd
会社情报监视，遍历所有数据，逐条比较内容校验是否变更；
* fn_App_EvtListenThd
监视序列号检测事件、命令响应事件;
* fn_App_SnpReqListenThd
画像取得超时事件
* fn_App_ConnInfoListenThd
地图数据状态、服务器状态、连接数更新</p><pre><code>b. 版本服务器监视线程 ：
* fn_Ver_CompanyInfoUpdThd
会社情报监视
* fn_Ver_ConnInfoUpdThd
数据库连接数更新

c. Hyr服务器
* fn_Hyr_ServerInfoListenThd
mst_Server_Management监视
</code></pre><h2 id=不成熟方案>不成熟方案</h2><ol><li>使用多线程、进程考虑</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>	多线程的优点：
</span></span><span style=display:flex><span>	方便高效的内存共享 - 多进程下内存共享比较不便，且会抵消掉多进程编程的好处
</span></span><span style=display:flex><span>	较轻的上下文切换开销 - 不用切换地址空间，不用更改CR3寄存器，不用清空TLB。
</span></span><span style=display:flex><span>	多进程的优点：
</span></span><span style=display:flex><span>	更强的容错性 - 一个进程crash不会导致整个系统崩溃
</span></span><span style=display:flex><span>	更好的多核可伸缩性 - 进程的使用将许多内核资源（如地址空间，页表，打开的文件）隔离，在多核系统上的可伸缩性强于多线程程序&lt;br/&gt;
</span></span><span style=display:flex><span>	综上，当你的不同任务间需要大量共享数据或频繁通信时，使用多线程，其他情况下尽量使用多进程。
</span></span><span style=display:flex><span>	提高多线程程序效率的一般方法：
</span></span><span style=display:flex><span>	不要频繁创建，销毁线程，使用线程池
</span></span><span style=display:flex><span>	减少线程间同步和通信（最为关键）
</span></span><span style=display:flex><span>	避免需要频繁共享写的数据
</span></span><span style=display:flex><span>	合理安排共享数据结构，避免伪共享（false sharing）
</span></span><span style=display:flex><span>	使用非阻塞数据结构/算法
</span></span><span style=display:flex><span>	避免可能产生可伸缩性问题的系统调用（比如mmap）
</span></span><span style=display:flex><span>	避免产生大量缺页异常，尽量使用Huge Page
</span></span><span style=display:flex><span>	可以的话使用用户态轻量级线程代替内核线程&lt;br/&gt;
</span></span><span style=display:flex><span>	作者：刘然
</span></span><span style=display:flex><span>	链接：https://www.zhihu.com/question/24485648/answer/27980547
</span></span><span style=display:flex><span>	来源：知乎
</span></span><span style=display:flex><span>	著作权归作者所有，转载请联系作者获得授权。
</span></span></code></pre></div></section><div class=divider></div><div class="flex flex-col md:flex-row justify-between gap-4 py-4"><a class="group btn btn-outline" href=/posts/docker-gdb/ title="gdb problem inside docker container"><ion-icon name=chevron-back></ion-icon><div class="inline-flex flex-col items-start"><span class="text-base-content/60 group-hover:text-neutral-content/60 text-xs font-normal">Previous page</span>
<span class="max-w-48 truncate">gdb problem inside docker container</span></div></a><a class="group btn btn-outline" href=/posts/docker/ title="docker install on windows"><div class="inline-flex flex-col items-end"><span class="text-base-content/60 group-hover:text-neutral-content/60 text-xs font-normal">Next page</span>
<span class="max-w-48 truncate">docker install on windows</span></div><ion-icon name=chevron-forward></ion-icon></a></div></article></div><div class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#数据层>数据层</a><ul><li><a href=#数据库驱动>数据库驱动</a></li><li><a href=#连接池>连接池</a></li></ul></li><li><a href=#网络层>网络层</a></li><li><a href=#应用逻辑层>应用逻辑层</a><ul><li><a href=#windows平台相关的变量声明>Windows平台相关的变量声明</a></li><li><a href=#windows服务----linux服务>Windows服务 &ndash;> Linux服务</a></li><li><a href=#windows网络库相关----linux-socket>Windows网络库相关 &ndash;> Linux Socket</a></li><li><a href=#配置文件及xml文件解析>配置文件及xml文件解析</a></li><li><a href=#文件相关>文件相关</a></li><li><a href=#eslc压缩库>Eslc压缩库</a></li><li><a href=#日志>日志</a></li><li><a href=#windows共享内存>windows共享内存</a></li><li><a href=#线程-事件-互斥量-临界区-信号量>线程 事件 互斥量 临界区 信号量</a></li><li><a href=#进程内存控制>进程内存控制</a></li><li><a href=#其他系统函数对应>其他系统函数对应</a></li><li><a href=#wsawaitformultiobjects>WSAWaitForMultiObjects</a></li></ul></li><li><a href=#数据缓存>数据缓存</a></li><li><a href=#不成熟方案>不成熟方案</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2016 - 2025 Caisong's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center h-[32px] px-2 gap-2 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card card-compact bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>大龄程序员，喜欢折腾各种环境部署、软件应用。</p><p>博客记录日常。</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2016 - 2025 Caisong's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center h-[32px] px-2 gap-2 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script type=module>
      import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
      mediumZoom('#dream-single-post-content img')
    </script><script type=module src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js></script><script nomodule src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js></script></body></html>